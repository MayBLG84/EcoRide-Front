<app-search-bar></app-search-bar>
<section class="headline-container">
  <h2>Le résultat de votre recherche</h2>
  <h5><em>Ensemble sur la voie verte</em></h5>
</section>

<section class="results-container">
  <!-- NO RESULTS -->
  @if (status === 'NO_MATCH' && !isLoading) {
  <div class="no-results">
    Malheureusement, aucun résultat ne correspond pas à votre recherche, ni à la date choisie, ni
    aux dates à venir.
  </div>
  }

  <!-- FUTURE MATCHS -->
  @if (status === 'FUTURE_MATCH' && !isLoading) {
  <div class="future-results-message">
    Aucune course n'a été trouvée pour la date choisie, mais voici quelques suggestions pour des
    dates futures :
  </div>
  }

  <!-- FILTERS & ORDER BAR -->
  @if (status === 'EXACT_MATCH') {
  <div class="filters-section">
    <div class="filters">
      <!-- Toggle filters -->
      <button class="btn btn-show-filter" (click)="toggleFilters()">
        <i class="bi bi-funnel"></i>
        <span>{{ filtersVisible ? 'Cacher les filtres' : 'Voir les filtres' }}</span>
      </button>

      <!-- Order -->
      <select class="btn btn-order-list" [(ngModel)]="orderBy" (change)="applyOrder()">
        <option value="" disabled>Trier par</option>
        <option value="PRICE_ASC">Prix croissant</option>
        <option value="PRICE_DESC">Prix décroissant</option>
        <option value="DURATION_ASC">Durée croissante</option>
        <option value="DURATION_DESC">Durée décroissante</option>
      </select>
    </div>

    <!-- FILTER PANEL -->
    @if (filtersVisible) {
    <div class="filters-panel">
      <!-- Electric -->
      <div class="filter-box electric">
        <div class="form-check form-switch mb-0">
          <input
            class="form-check-input primary-toggle"
            type="checkbox"
            id="electricSwitch"
            [(ngModel)]="filters.electricOnly"
          />
          <label class="form-check-label switch-label" for="electricSwitch"
            >Voiture électrique</label
          >
        </div>
      </div>

      <!-- Price -->
      <div class="filter-box price">
        <span>Prix:</span>
        <small>{{ filters.priceMin }} €</small>
        <input
          type="range"
          class="form-range mx-2"
          [min]="filtersMeta!.price.min"
          [max]="filtersMeta!.price.max"
          [(ngModel)]="filters.priceMax"
        />
        <small>{{ filters.priceMax }} €</small>
      </div>

      <!-- Duration -->
      <div class="filter-box duration">
        <span>Durée:</span>
        <small>{{ formatDuration(filters.durationMin) }}</small>
        <input
          type="range"
          class="form-range mx-2"
          [min]="filtersMeta!.duration.min"
          [max]="filtersMeta!.duration.max"
          [(ngModel)]="filters.durationMax"
        />
        <small>{{ formatDuration(filters.durationMax) }}</small>
      </div>

      <!-- Rating -->
      <div class="filter-box rating">
        <span class="span-text">Conducteur.trice:</span>
        @for (s of [1, 2, 3, 4, 5]; track s) {
        <span class="star-icon" (click)="filters.ratingMin = s">
          <i
            [class.bi-star]="s > filters.ratingMin"
            [class.bi-star-fill]="s <= filters.ratingMin"
          ></i>
        </span>
        }
        <span class="ms-1">ou +</span>
      </div>
    </div>
    <div class="btn-apply-filters-section">
      <!-- APPLY -->
      <button class="btn-apply-filters" (click)="applyFilters()">Appliquer les filtres</button>
      @if (hasActiveFilters()) {
      <button class="btn-clear-filters" (click)="clearFilters()">Réinitialiser les filtres</button>
      }
    </div>
    }
  </div>
  }

  <div class="rides-field">
    <!-- RIDE CARD -->
    @for (ride of rides; track ride.id) {

    <div class="card-wrapper">
      <!-- Header -->
      <div class="card-header driver-grid">
        <img
          class="driver-photo"
          [src]="getDriverImage(ride)"
          (error)="onImageError($event)"
          alt="Image du chauffeur/ de la chauffeuse"
        />

        <h6 class="driver-label">Chauffeur.euse :</h6>
        <p class="driver-nickname">{{ ride.driver.nickname }}</p>

        <div class="driver-rating">
          @for (s of [1, 2, 3, 4, 5]; track s) {
          <i
            [class.bi-star-fill]="getStarType(s, ride.driver.avgRating) === 'full'"
            [class.bi-star-half]="getStarType(s, ride.driver.avgRating) === 'half'"
            [class.bi-star]="getStarType(s, ride.driver.avgRating) === 'empty'"
          ></i>
          }
        </div>

        @if (ride.vehicle.isElectric) {
        <div class="icon-vehicle-electric">
          <img src="assets/ev-charger-station.png" alt="Icône d'une voiture electrique" />
        </div>
        }
      </div>

      <!-- Date & Seats -->
      <div class="ride-date">
        <h3>{{ ride.date }}</h3>
      </div>
      <div class="ride-seats">
        <p>
          Il y a {{ ride.availableSeats }}
          {{ ride.availableSeats === 1 ? 'place' : 'places' }} disponible(s)
        </p>
      </div>

      <!-- Main Content -->
      <div class="ride-content">
        <div class="item-ride">
          <h6>Ville de départ :</h6>
          <p>{{ ride.origin.city }}</p>
        </div>
        <div class="item-ride">
          <h6>Ville d'arrivée :</h6>
          <p>{{ ride.destiny.city }}</p>
        </div>
        <div class="item-ride">
          <h6>Heure de départ :</h6>
          <p>{{ ride.departureTime }}</p>
        </div>
        <div class="item-ride">
          <h6>Durée estimée :</h6>
          <p>{{ formatDuration(ride.estimatedDuration) }}</p>
        </div>
      </div>

      <!-- Details -->
      @if (ride.showDetails) {
      <div class="ride-details">
        <div class="item-ride">
          <h6>Point de rencontre :</h6>
          <p>{{ ride.origin.pickPoint }}</p>
        </div>

        <div class="item-ride">
          <h6>Point de dépôt :</h6>
          <p>{{ ride.destiny.dropPoint }}</p>
        </div>

        <div class="item-ride">
          <h6>Modèle du véhicule :</h6>
          <p>{{ ride.vehicle.model }}</p>
        </div>

        <div class="item-ride">
          <h6>Marque du véhicule :</h6>
          <p>{{ ride.vehicle.brand }}</p>
        </div>

        <div class="item-ride">
          <h6>Préférences du/de la Chauffeur.euse :</h6>
          <p class="p-preferences">Fumeur : {{ ride.preferences.smoker ? 'oui' : 'non' }}</p>
          <p>Animaux permis : {{ ride.preferences.animals ? 'oui' : 'non' }}</p>
          @if (ride.preferences.other) {
          <p>{{ ride.preferences.other }}</p>
          }
        </div>
      </div>
      }

      <!-- Toggle Details -->
      <button
        class="btn btn-details"
        [class.btn-details--active]="ride.showDetails"
        (click)="toggleDetails(ride)"
      >
        {{ ride.showDetails ? 'Cacher les détails' : 'Voir les détails' }}
      </button>

      <!-- Price & Participate -->
      <div class="bottom-row">
        <div class="ride-price">{{ ride.pricePerPerson }} €</div>

        <button
          class="btn btn-participate"
          [class.btn-participate--active]="ride.participating && auth.isLoggedIn()"
          [class.btn-participate--login]="!auth.isLoggedIn()"
          (click)="participate(ride)"
        >
          {{
            !auth.isLoggedIn()
              ? 'Se connecter pour participer'
              : ride.participating
              ? 'Annuler ma participation'
              : 'Participer'
          }}
        </button>
      </div>
    </div>

    }

    <!-- Show More Button -->
    @if (rides.length < totalResults) {
    <div class="show-more-container">
      <button class="btn btn-show-more" (click)="loadRides()" [disabled]="isLoading">
        {{ isLoading ? 'Chargement...' : 'Voir plus de résultats' }}
      </button>
    </div>
    }
  </div>

  <!-- LOADING -->
  @if (isLoading) {
  <div class="loading">Chargement...</div>
  }
</section>
